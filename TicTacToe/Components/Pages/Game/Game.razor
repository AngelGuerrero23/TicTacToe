@page "/game/{PartidaId:int}"
@using TicTacToe.DAL
@inject NavigationManager Navigation
@inject IJugadoresApiService jugadoresService
@inject IPartidasApiService partidasService
@rendermode InteractiveServer
@inject IMovimientosApiService movimientosService

<!-- PANTALLA DE JUEGO -->

<div class="container mx-auto max-w-lg p-6 bg-white rounded-lg shadow-xl text-center">
    <div class="game-container">
        <div class="container-lg card-body">PartidaID: @PartidaId</div>
        <h2 class="game-status">@GameStatus</h2>
        <div class="game-screen">
            <div class="game-board">
                @for (var i = 0; i < 9; i++)
                {
                    var cellIndex = i; // Copia local para evitar problemas con el closure en el lambda
                                       <button class="cell @GetPlayerClass(board[cellIndex])"
                                               @onclick="() => HandleCellClick(cellIndex)"
                                               disabled="@(board[cellIndex] != null || winner != null || esEmpate)">
                                           @board[cellIndex]?.ToString()
                                       </button>
                }
            </div>
            <button class="btn btn-secondary mt-4" @onclick="RestartGame">
                Reiniciar Juego
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public int PartidaId { get; set; }
    private enum PlayerType {X,O};
    public string JugadorName1 { get; set; }
    public string JugadorName2{ get; set; }


    private PlayerType?[] board = new PlayerType?[9];
    private PlayerType _currentPlayerType = PlayerType.X;
    private PlayerType? winner;
    private bool esEmpate;

    protected override async Task OnInitializedAsync()
    {

        await CargarTablero();
        esEmpate = board.All(cell => cell != null);
        await CargarNombres();
        winner = CheckForWinner();
    }



    private string GameStatus
    {
        get
        {
            if (winner != null)
                return $"🏆 ¡Ganador: {(winner == PlayerType.X ? JugadorName1 : JugadorName2)}!";
            return esEmpate 
                ? "🤝 ¡Es un empate!"
                : $"Turno de: {(_currentPlayerType == PlayerType.X ? JugadorName1 : JugadorName2)}";
        }
    }

    public async Task CargarTablero()
    {
        var movimientos = await movimientosService.GetMovimientosAsync(PartidaId);
        foreach (var movimiento in movimientos.Data)
        {
            board[(movimiento.PosicionFila * 3) + movimiento.PosicionColumna] = Enum.Parse<PlayerType>(movimiento.Jugador);
            _currentPlayerType = Enum.Parse<PlayerType>(movimiento.Jugador) == PlayerType.X ? PlayerType.O : PlayerType.X;
        }
    }

    public async Task CargarNombres()
    {
        var partida = (await partidasService.GetPartidaAsync(PartidaId)).Data;
        JugadorName1 = (await jugadoresService.GetJugadorAsync(partida.Jugador1Id)).Data.Nombres;
        JugadorName2 = (await jugadoresService.GetJugadorAsync(partida.Jugador2Id ?? 0)).Data.Nombres;
    }

    private async Task HandleCellClick(int index)
    {
        // Ignorar si la celda está ocupada o el juego terminó
        if (board[index] != null || winner != null || esEmpate)
            return;

        board[index] = _currentPlayerType;
        await movimientosService.PostMovimiento(PartidaId, _currentPlayerType.ToString(), index / 3, index % 3);

        // Fix: Switch player type correctly
        _currentPlayerType = (_currentPlayerType == PlayerType.X) ? PlayerType.O : PlayerType.X;

        @*Verificar Ganador*@
        winner = CheckForWinner();
        if (winner != null)
        {
            return; 
        }
        esEmpate = board.All(cell => cell != null);
    }

    private PlayerType? CheckForWinner()
    {
        var winningLines = new[]
        {
             new[] {0, 1, 2}, new[] {3, 4, 5}, new[] {6, 7, 8},// Horizontales
             new[] {0, 3, 6}, new[] {1, 4, 7}, new[] {2, 5, 8},// Verticales
             new[] {0, 4, 8}, new[] {2, 4, 6}// Diagonales
        };

        foreach (var line in winningLines)
        {
            var (a, b, c) = (line[0], line[1], line[2]);
            if (board[a].HasValue && board[a] == board[b] && board[a] == board[c])
            {
                return board[a];
            }
        }

        return null; // No hay ganador
    }

    private async Task RestartGame()
    {
        var partida = (await partidasService.GetPartidaAsync(PartidaId)).Data;
        int jugador1 = partida.Jugador1Id;
        int jugador2 = partida.Jugador2Id ?? 0;
        var crear = (await partidasService.PostPartida(jugador1, jugador2));

        if (crear is Resource<PartidaResponse>.Success success)
        {
            Navigation.NavigateTo($"/game/{success.Data.PartidaId}");
        }

    }

    private string GetPlayerClass(PlayerType? jugador)
    {
        if (jugador == null) return "";
        return jugador == PlayerType.X ? "player-x" : "player-o";
    }

}