@page "/Partidas/Index"
@using TicTacToe.Models;
@inject IPartidasApiService partidasService
@inject IJugadoresApiService jugadoresApiService
@inject NavigationManager navigationManager
@rendermode InteractiveServer

<PageTitle>Partidas</PageTitle>

<div class="card shadow">
    <!-- Header -->
    <div class="card-header text-black">
        <h3 class="mb-0">Listado de Partidas</h3>
        <div class="row mt-2">
            <div class="col-3">
                <label class="col-form-label"><strong>Filtrar por</strong></label>
            </div>
            <div class="col-4">
                <label class="col-form-label"><strong>Búsqueda</strong></label>
            </div>
        </div>
        <div class="row align-items-center">
            <div class="col-3">
                <InputSelect class="form-select" @bind-Value="Filtro">
                    <option value="" selected disabled>Elija una opción</option>
                    <option value="PartidaId">Partida Id</option>
                    <option value="Jugador1Id">Jugador 1</option>
                    <option value="Jugador2Id">Jugador 2</option>
                </InputSelect>
            </div>
            <div class="col-4">
                <div class="input-group">
                    <input class="form-control" @bind="ValorFiltro" placeholder="Buscar" />
                    <button type="button" class="btn btn-outline-dark" @onclick="Buscar">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                </div>
            </div>
            <div class="col-4">
                <a href="/" class="btn btn-success">
                    <span class="bi bi-plus-circle"></span> Crear Nueva Partida
                </a>
            </div>
        </div>
    </div>

    <!-- Body -->
    <div class="card-body p-0">
        @if (ListaPartidas == null)
        {
            <p>Cargando...</p>
        }
        else
        {
            <table class="table table-striped table-bordered mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>PartidaId</th>
                        <th>Jugador1</th>
                        <th>Jugador2</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var partida in ListaPartidas)
                    {
                        <tr>
                            <td>@partida.PartidaId</td>
                            <td>@ObtenerNombreJugador(partida.Jugador1Id)</td>
                            <td>@(partida.Jugador2Id.HasValue ? ObtenerNombreJugador(partida.Jugador2Id.Value) : "Esperando jugador...")</td>
                            <td>
                                @if (!partida.Jugador2Id.HasValue)
                                {
                                    <button class="btn btn-primary btn-sm" @onclick="() => UnirsePartida(partida.PartidaId)">
                                        <i class="bi bi-controller"></i> Unirse
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted">Partida llena</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>

    <!-- Footer -->
    <div class="card-footer text-end">
        Cantidad: @(ListaPartidas?.Count ?? 0)
    </div>
</div>

@code {
    private List<PartidaResponse> ListaPartidas { get; set; }
    private string Filtro { get; set; } = string.Empty;
    private string ValorFiltro { get; set; } = string.Empty;
    private List<JugadorResponse> ListaJugadorResponse { get; set; } = new List<JugadorResponse>();

    protected override async Task OnInitializedAsync()
    {
        await CargarJugadores();
        await CargarPartidas();
    }

    private async Task CargarPartidas()
    {
        var response = await partidasService.GetPartidasAsync();
        if (response is Resource<List<PartidaResponse>>.Success success)
        {
            ListaPartidas = success.Data;
        }
        else if (response is Resource<List<PartidaResponse>>.Error error)
        {
            Console.WriteLine($"Error al cargar partidas: {error.Message}");
        }
    }

    private async Task CargarJugadores()
    {
        var response = await jugadoresApiService.GetJugadoresAsync();
        if (response is Resource<List<JugadorResponse>>.Success success)
        {
            ListaJugadorResponse = success.Data;
        }
    }

    private string ObtenerNombreJugador(int jugadorId)
    {
        return ListaJugadorResponse.FirstOrDefault(j => j.jugadorId == jugadorId)?.Nombres ?? $"Jugador {jugadorId}";
    }

    private async Task UnirsePartida(int partidaId)
    {
        var response = await partidasService.GetPartidaAsync(partidaId);
        if (response is Resource<PartidaResponse>.Success success)
        {
            var partida = success.Data;
            if (partida != null)
            {
                navigationManager.NavigateTo($"/game/{partidaId}");
            }
        }
        else if (response is Resource<PartidaResponse>.Error error)
        {
            Console.WriteLine($"Error al unirse a la partida: {error.Message}");
        }
    }

    private async Task Buscar()
    {
        await CargarPartidas();
        if (!string.IsNullOrWhiteSpace(ValorFiltro))
        {
            ListaPartidas = ListaPartidas.Where(p => 
                Filtro switch
                {
                    "PartidaId" => p.PartidaId.ToString().Contains(ValorFiltro),
                    "Jugador1Id" => p.Jugador1Id.ToString().Contains(ValorFiltro),
                    "Jugador2Id" => p.Jugador2Id?.ToString()?.Contains(ValorFiltro) ?? false,
                    _ => true
                }).ToList();
        }
    }
}